<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <property name="now" value="now()" dbms="h2"/>

    <property name="now" value="now()" dbms="mysql"/>
    <property name="autoIncrement" value="true"/>

    <property name="floatType" value="float4" dbms="postgresql, h2"/>
    <property name="floatType" value="float" dbms="mysql, oracle, mssql"/>

    <changeSet author="mathieu.goulene" id="20180723072100-1">
        <createView fullDefinition="false" viewName="operation_report_by_month">select str_to_date(concat(year(`myaccountv5`.`operation`.`jhi_date`),'-',month(`myaccountv5`.`operation`.`jhi_date`),'-','01'),'%Y-%m-%d') AS `month`,`myaccountv5`.`sub_category`.`category_id` AS `category_id`,`myaccountv5`.`operation`.`account_id` AS `account_id`,sum(`myaccountv5`.`operation`.`amount`) AS `amount` from (`myaccountv5`.`operation` join `myaccountv5`.`sub_category` on((`myaccountv5`.`operation`.`sub_category_id` = `myaccountv5`.`sub_category`.`id`))) group by str_to_date(concat(year(`myaccountv5`.`operation`.`jhi_date`),'-',month(`myaccountv5`.`operation`.`jhi_date`),'-','01'),'%Y-%m-%d'),`myaccountv5`.`sub_category`.`category_id`,`myaccountv5`.`operation`.`account_id`</createView>
    </changeSet>
    <changeSet author="mathieu.goulene" id="20180723072100-2">
        <createView fullDefinition="false" viewName="operation_report">select `m1`.`month` AS `month`,`m1`.`account_id` AS `account_id`,`m1`.`category_id` AS `category_id`,`m1`.`amount` AS `amount`,avg(`m2`.`amount`) AS `amount_avg_3`,avg(`m3`.`amount`) AS `amount_avg_12` from ((`myaccountv5`.`operation_report_by_month` `m1` join `myaccountv5`.`operation_report_by_month` `m2` on(((`m1`.`category_id` = `m2`.`category_id`) and (`m1`.`account_id` = `m2`.`account_id`)))) join `myaccountv5`.`operation_report_by_month` `m3` on(((`m1`.`category_id` = `m3`.`category_id`) and (`m1`.`account_id` = `m3`.`account_id`)))) where ((`m2`.`month` &lt;= `m1`.`month`) and (`m2`.`month` &gt;= (`m1`.`month` + interval -(2) month)) and (`m3`.`month` &lt;= `m1`.`month`) and (`m3`.`month` &gt;= (`m1`.`month` + interval -(11) month))) group by `m1`.`month`,`m1`.`category_id`,`m1`.`account_id` order by `m1`.`category_id`,`m1`.`month`</createView>
    </changeSet>
    <changeSet author="mathieu.goulene" id="20180723072100-3">
        <createView fullDefinition="false" viewName="budget_report">select `bi`.`account_id` AS `account_id`,`bi`.`category_id` AS `category_id`,`bip`.`month` AS `month`,sum(`bip`.`amount`) AS `budget_amount` from (`myaccountv5`.`budget_item` `bi` join `myaccountv5`.`budget_item_period` `bip` on((`bi`.`id` = `bip`.`budget_item_id`))) group by `bi`.`account_id`,`bi`.`category_id`,`bip`.`month`</createView>
    </changeSet>
    <changeSet author="mathieu.goulene" id="20180723072100-4">
        <createView fullDefinition="false" viewName="account_report">select concat(`br`.`account_id`,'-',`br`.`category_id`,'-',`br`.`month`) AS `id`,`br`.`account_id` AS `account_id`,`br`.`month` AS `month`,`br`.`category_id` AS `category_id`,`br`.`budget_amount` AS `budget_amount`,`opr`.`amount` AS `amount`,`opr`.`amount_avg_3` AS `amount_avg_3`,`opr`.`amount_avg_12` AS `amount_avg_12` from (`myaccountv5`.`budget_report` `br` left join `myaccountv5`.`operation_report` `opr` on(((`br`.`account_id` = `opr`.`account_id`) and (`br`.`month` = `opr`.`month`) and (`br`.`category_id` = `opr`.`category_id`))))</createView>
     </changeSet>
</databaseChangeLog>